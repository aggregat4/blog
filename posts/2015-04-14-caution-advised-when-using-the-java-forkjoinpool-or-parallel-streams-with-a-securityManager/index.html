<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Boris Terzic">
    <meta property="og:title" content="Caution advised when using the Java ForkJoinPool or parallel streams with a SecurityManager">
    
    <meta name="description" content="Personal website for Boris Terzic with blog posts on programming and technology">
    <meta property="og:description" content="Personal website for Boris Terzic with blog posts on programming and technology">
    
    
    <meta property="og:url" content="https://blog.boristerzic.com/posts/2015-04-14-caution-advised-when-using-the-java-forkjoinpool-or-parallel-streams-with-a-securityManager/">
    
    <title>Caution advised when using the Java ForkJoinPool or parallel streams with a SecurityManager</title>    
    <link rel="canonical" href="https://blog.boristerzic.com/posts/2015-04-14-caution-advised-when-using-the-java-forkjoinpool-or-parallel-streams-with-a-securityManager/" />
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
  <style>
    
      /********** reset from https://andy-bell.co.uk/a-more-modern-css-reset/ **********/

/* Box sizing rules */
*,
*::before,
*::after {
  box-sizing: border-box;
}

/* Prevent font size inflation */
html {
  -moz-text-size-adjust: none;
  -webkit-text-size-adjust: none;
  text-size-adjust: none;
}

/* Remove default margin in favour of better control in authored CSS */
body, h1, h2, h3, h4, p,
figure, blockquote, dl, dd {
  margin: 0;
}

/* Set core body defaults */
body {
  min-height: 100vh;
  line-height: 1.55;
  font-size: 18px;
  font-family: system-ui, sans-serif;
}

/* Set shorter line heights on headings and interactive elements */
h1, h2, h3, h4,
button, input, label {
  line-height: 1.1;
}

/* Balance text wrapping on headings */
h1, h2,
h3, h4 {
  text-wrap: balance;
}

/* A elements that don't have a class get default styles */
a:not([class]) {
  text-decoration-skip-ink: auto;
}

/* Make images easier to work with */
img,
picture {
  max-width: 100%;
  display: block;
}

/* Inherit fonts for inputs and buttons */
input, button,
textarea, select {
  font: inherit;
}

/* Make sure textareas without a rows attribute are not tiny */
textarea:not([rows]) {
  min-height: 10em;
}

/* Anything that has been anchored to should have extra scroll margin */
:target {
  scroll-margin-block: 5ex;
}

/********** end reset **********/


:root {
  --spacing-xs: 8px;
  --spacing-s: 12px;
  --spacing: 24px;
  --spacing-m: 36px;
  /* Color scheme 324, page 233 from A Dictionary of Color Combinations */
  --pompeian-red: rgb(162, 46, 55);
  --olympic-blue: #247291;
  --olympic-blue-intensive: #154457;
  --aconite-violet: #85608e;
  --aconite-violet-dark: #492552;
  --neutral-gray: #B5D1CC;
  --color-gainsboro: #DCDCDC;
  --color-code-bg: #f5f2f0;

  --max-readable-column-width: 75ch;

  --link-color: var(--olympic-blue-intensive);
  /* --visited-link-color: var(--aconite-violet-dark); */
  --visited-link-color: var(--olympic-blue-intensive);
}

/* TODO: dark theme */
@media (prefers-color-scheme: dark) {
}

::selection {
  background: var(--olympic-blue);
  color: white;
}

header {
  /* margin: auto; */
  /* max-width: var(--max-readable-column-width); */
  display: flex;
  justify-content: left;
  align-items: center;
}

footer {
  margin: auto;
  display: flex;
  justify-content: center;
}

footer {
  font-size: 21px;
  margin-bottom: var(--spacing);
}

main {
  margin: auto;
  padding: 0 var(--spacing) var(--spacing) var(--spacing);
}

body.page-other main {
  max-width: var(--max-readable-column-width);
}

nav {
  text-transform: uppercase;
  font-weight: 400;
  margin: var(--spacing);
  border-radius: 3px;
  border: 1px #333333 solid;
  box-shadow: 2px 2px 3px 0 #bbbbbb;

  ol {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    padding: 0;
    margin: 0;
    
    li {
      margin: var(--spacing-s);
      list-style-type: none;

      svg {
        width: 30px;
      }
    }

    a {
      /* This is needed because anchor elements are inline by default and get strange heights dependending on what is in them.
         Setting them to block helps but then the contents are not aligned.
         Setting them to center in this case makes all the nav elements nicely vertically aligned. */
      display: flex;
    }

    a, a:visited {
      color: black;
      text-decoration: none;
    }
  }
}


a {
  color: var(--link-color);

  &:visited {
    color: var(--visited-link-color);
  }
}


h1, h2, h3, h4, h5, h6 {
  font-family: system-ui, sans-serif;
  font-weight: 500;
  margin: 1.6ex 0 1ex 0;
}
h1 {
  font-size: 2em;
  /* line-height: calc(1ex / 0.42);
  margin: calc(1ex / 0.42) 0 1ex 0; */
}
h2 {
  font-size: 1.8em;
  /* line-height: calc(1ex / 0.37);
  margin: calc(1ex / 0.37) 0 1ex 0; */
}
h3 {
  font-size: 1.3em;
  /* line-height: calc(1ex / 0.32);
  margin: calc(1ex / 0.32) 0 1ex 0; */
}
h4 {
  font-size: 1.15em;
  /* line-height: calc(1ex / 0.28);
  margin: calc(1ex / 0.28) 0 1ex 0; */
}


.cover {
  text-align: center;
  line-height: 400%;
  border: 1px solid black;
  margin-bottom: var(--spacing);
  
  h1 {
    border: none;
    word-wrap: break-all;
    font-size: 3.5em;
  }

  h1, h2 {
    letter-spacing: 12px;
  }  
}


article {
  p, pre, ul, ol, blockquote {
    /* margin: calc(1ex / 0.42) 0 0 0; */
    margin: var(--spacing) 0 0 0;
  }

  code {
    background-color: var(--color-code-bg);
    padding: 0 4px;
  }
  
  .postdate {
    display: block;
    text-align: left;
    margin: 0;
    font-family: monospace;
  }

  time {
    font-style: italic;
    font-size: 12px;
  }

  pre, code {
    font-family: monospace;
    font-size: 18px;
    border-radius: 3px;
  }
  
  pre {
    padding: var(--spacing-s);
    background-color: var(--color-code-bg);
    overflow-x: auto;
    overflow-y: hidden;
  }


  blockquote {
    padding: var(--spacing-s);
    border-left: 2px solid var(--olympic-blue);
    background-color: var(--color-code-bg);
    font-style: italic;
    margin-left: calc(-1 * var(--spacing-s) - 2px);

    p:first-of-type {
      margin: 0;
    }
  }
}

article p:first-of-type,
h1 + p,
h2 + p,
h3 + p,
h4 + p,
p + ul {
  margin-top: var(--spacing-s);
}


/* Container for logo and postlist sections */
.index-container {
  display: flex;
  flex-direction: column;
  gap: var(--spacing);
  align-items: center;
}

.logo-section {
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-section img {
  max-width: 100%;
  /* min-width: 300px; */
  /* margin: var(--spacing); */
}

section.postlist {
  max-width: var(--max-readable-column-width);

  ol {
    padding: 0;
    margin: 0;
    margin-top: var(--spacing-s);

    time {
      display: block;
      font-family: monospace;
      font-size: 12px;
      line-height: 1;
    }

    li {
      margin-bottom: var(--spacing-s);
      list-style-type: none;
    }  
  } 
}


@media only screen and (min-width: 1100px)  {
  .index-container {
    flex-direction: row;
    align-items: flex-start;
    gap: var(--spacing-m);
  }

  .logo-section {
    flex-shrink: 0;
  }
}

    
  </style>
  </head>
  <body class="page-other">
    <header>
      <nav>
        <ol>
          
          <li><a href="/" alt="Apparat blog homepage"><svg version="1.1" viewBox="0 0 27.391 25.683" xmlns="http://www.w3.org/2000/svg"><g transform="translate(-42.444 -49.082)"><rect x="42.444" y="49.082" width="27.391" height="25.683" style="font-variation-settings:'wght' 600"/></g><g transform="translate(-42.444 -49.082)"><path d="m48.082 70.46c-0.19587 0-0.3591-0.03265-0.48968-0.09794-0.13058-0.04897-0.19587-0.13874-0.19587-0.26932 0-0.1469 0.05713-0.26116 0.17139-0.34278 0.13058-0.08162 0.29381-0.15507 0.48968-0.22036 0.47336-0.13058 0.88143-0.32646 1.2242-0.58762 0.3591-0.27749 0.64475-0.65291 0.85694-1.1263 0.40807-0.96304 0.79981-1.8853 1.1752-2.7667 0.37542-0.89775 0.73452-1.7873 1.0773-2.6688 0.34278-0.88143 0.68555-1.7792 1.0283-2.6932 0.3591-0.91407 0.7182-1.8771 1.0773-2.8891 0.17955-0.506 0.30197-0.89775 0.36726-1.1752 0.06529-0.27749 0.12242-0.48152 0.17139-0.6121 0.24484-0.06529 0.47336-0.13058 0.68555-0.19587 0.21219-0.06529 0.44887-0.1469 0.71004-0.24484 0.22852-0.11426 0.42439-0.26116 0.58762-0.44071s0.28565-0.31829 0.36726-0.41623c0.04897-0.03265 0.09794-0.04897 0.1469-0.04897 0.04897-0.01632 0.09794 0.01632 0.1469 0.09794 0.04897 0.09793 0.08977 0.19587 0.12242 0.29381 0.03265 0.09794 0.06529 0.20404 0.09794 0.31829 0.3591 1.1589 0.72636 2.3341 1.1018 3.5257 0.39175 1.1752 0.77533 2.3423 1.1508 3.5012 0.37542 1.1426 0.73452 2.2444 1.0773 3.3053 0.3591 1.0447 0.68555 2.0077 0.97936 2.8891 0.1469 0.44071 0.32646 0.79165 0.53865 1.0528 0.22852 0.26116 0.47336 0.4652 0.73452 0.6121 0.27749 0.13058 0.57946 0.23668 0.90591 0.31829 0.2122 0.04897 0.37542 0.11426 0.48968 0.19587 0.11426 0.08162 0.17139 0.19587 0.17139 0.34278 0 0.09794-0.05713 0.17139-0.17139 0.22036-0.09794 0.04897-0.22852 0.07345-0.39174 0.07345-0.29381 0-0.66923-0.0082-1.1263-0.02448-0.44071-0.01632-0.89775-0.03265-1.3711-0.04897-0.47336-0.03265-0.89775-0.04897-1.2732-0.04897-0.32645 0-0.69372 0.0082-1.1018 0.02448-0.39174 0.01632-0.79165 0.03265-1.1997 0.04897-0.39174 0.01632-0.72636 0.02448-1.0038 0.02448-0.16323 0-0.31013-0.02448-0.44071-0.07345-0.11426-0.06529-0.17139-0.15506-0.17139-0.26932 0-0.13058 0.06529-0.23668 0.19587-0.31829 0.13058-0.09794 0.28565-0.16323 0.4652-0.19587 0.58762-0.09794 1.012-0.24484 1.2732-0.44071 0.26116-0.2122 0.3591-0.51416 0.29381-0.90591-0.04897-0.27749-0.12242-0.60394-0.22036-0.97936-0.09794-0.39174-0.20403-0.79165-0.31829-1.1997-0.09794-0.42439-0.20403-0.80797-0.31829-1.1508-0.03265-0.13058-0.08162-0.22036-0.1469-0.26932-0.06529-0.06529-0.18771-0.09794-0.36726-0.09794h-4.4071c-0.11426 0-0.20403 0.0408-0.26932 0.12242-0.06529 0.06529-0.11426 0.17139-0.1469 0.31829-0.06529 0.2122-0.1469 0.45704-0.24484 0.73452-0.08162 0.26116-0.17139 0.53865-0.26932 0.83246-0.08162 0.27749-0.16323 0.53865-0.24484 0.78349-0.06529 0.24484-0.11426 0.45704-0.1469 0.63658-0.08162 0.44071-0.0082 0.79165 0.22036 1.0528 0.24484 0.24484 0.66107 0.44071 1.2487 0.58762 0.44071 0.11426 0.66107 0.28565 0.66107 0.51416 0 0.09794-0.05713 0.17955-0.17139 0.24484-0.09793 0.04897-0.24484 0.07345-0.44071 0.07345-0.37542 0-0.76717-0.01632-1.1752-0.04897-0.40807-0.01632-0.85694-0.02448-1.3466-0.02448-0.48968 0-0.9712 0.02448-1.4446 0.07345-0.45704 0.04897-0.92223 0.07345-1.3956 0.07345zm5.8272-7.1004h3.4033c0.22852 0 0.34278-0.04897 0.34278-0.1469 0-0.04897-0.0082-0.08977-0.02448-0.12242 0-0.03265-0.0082-0.08162-0.02448-0.1469l-1.7139-5.6558c-0.06529-0.22852-0.12242-0.34278-0.17139-0.34278-0.03265 0-0.08977 0.1061-0.17139 0.31829l-2.0567 5.6803c-0.03265 0.08162-0.04897 0.1469-0.04897 0.19587 0 0.08162 0.0408 0.13874 0.12242 0.17139 0.09794 0.03265 0.2122 0.04897 0.34278 0.04897z" fill="#fff" stroke-width=".25504" style="font-variation-settings:'wght' 600" aria-label="(A)"/></g></svg></a></li>
          
          <li><a href="/pages/impressum/" alt="About page">About</a></li>
        </ol>
      </nav>
    </header>
    <main>
      <article>
<h1>Caution advised when using the Java ForkJoinPool or parallel streams with a SecurityManager</h1>

<time datetime="2015-04-14">2015-04-14</time>

<p>In Java 7 the <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/forkjoin.html">fork/join framework</a> was introduced as an additional tool in the concurrency toolbox. It can be used to conveniently solve problems that lend themselves to easy subdivision, in a parallell fashion without having to worry about any concurrency mechanics.\n<br>
Aside from being a convenient user facing feature, this framework has also become the basis for other JDK implementations that require such a parallellization approach. Features like <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Arrays.html"><code>Arrays.parallelSort()</code></a> and <a href="https://docs.oracle.com/javase/tutorial/collections/streams/parallelism.html">parallel streams</a>. And there lies the rub.</p>
<p>The fork/join framework uses a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html"><code>ForkJoinPool</code></a> to take the parallel tasks and execute them on a bunch of threads. By default it will use its own implementation of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.ForkJoinWorkerThreadFactory.html"><code>ForkJoinPool.ForkJoinWorkerThreadFactory</code></a> to construct the threads to be used, but it can be configured with a custom factory in its constructor.</p>
<p>In the case of JDK features such as parallel streams there is no API to specify this factory. In fact the JDK will default to using a system wide, static ForkJoinPool that is stored inside of the <code>common</code> field of the ForkJoinPool class. This pool is initialized in the method <code>makeCommonPool</code> of the same class.</p>
<p>This common pool turns out to be constructed in a very specific, very peculiar way. As Doug Lea explains in a <a href="http://cs.oswego.edu/pipermail/concurrency-interest/2013-December/012123.html">post</a> to the <a href="http://cs.oswego.edu/pipermail/concurrency-interest/">concurrency-interest</a> mailing list, there was a concern that these “easy” ways to parallelize certain workloads could put undue strain on certain production systems and it was felt to be necessary, or at least desirable, to allow administrators to limit the amount of implicit parallelism exhibited by the JVM in certain production scenarios.</p>
<p>One result of this policy is that the logic for instantiating the common pool defaults to using a different, very conservative, ForkJoinWorkerThreadFactory implementation called the <a href="http://hg.openjdk.java.net/jdk8/jdk8/jdk/diff/e2bdddb8bedf/src/share/classes/java/util/concurrent/ForkJoinPool.java"><code>InnocuousForkJoinWorkerThreadFactory</code></a> when it <em>detects that a SecurityManager is active</em>. This implementation runs worker threads with no permissions. This allows “innocuous” parallelism where something is calculated for example, but prevents parallel tasks from doing anything that requires permissions such as opening files.</p>
<p>This leads us to the first problem: when running with a security manager you get a different configuration of the common pool and you may not be able to run your parallel code, depending on its required permissions. Luckily there is a workaround for this. The ForkJoinPool <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html">documents</a> a system property called <code>java.util.concurrent.ForkJoinPool.common.threadFactory</code> that allows you to specifically set the ThreadFactory implementation to be used. With this you can provide your own implementation that runs with normal permissions and Bob is your uncle.</p>
<p>Unless you are running in a WebStart environment. Wait, does anyone still use WebStart? Yes, sadly, we do. Since JDK 7u45 <a href="https://bugs.openjdk.java.net/browse/JDK-8023821">“insecure properties set in a JNLP file are no longer passed to the application”</a>, unless you sign your JNLP file. The ThreadFactory property is not a secure property. Either you sign your JNLP files (which is incredibly cumbersome, and in the case of required customer customization, often not economically feasible) or you wrap that property in a <code>jnlp.</code> prefixed “secure” property and translate that inside your application into the right property.</p>
<p>Assuming that you did this (and we did) it will sadly still not work. When running in a Java WebStart environment, <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/javaws/developersguide/faq.html#s211">a user-level classloader is used to load all resources specified in the JNLP file</a> and as a result you can no longer use <code>Class.forName</code> or <code>ClassLoader.getSystemClassLoader</code> to load resources and classes. The ForkJoinPool uses <code>ClassLoader.getSystemClassLoader</code> to try to load the custom ThreadFactory you set using the system property and will fail.</p>
<p>The executive summary is that if you are running your application using Java WebStart you <em>must</em> construct your ForkJoinPool instances with a custom ThreadFactory if you want to parallelize any operation that requires security permissions and you <em>should not</em> use parallel streams for such operations. At work we have decided not to use parallel streams at all until we have a usable workaround for the described problem.</p>


</article>

    </main>
    <footer>
      
      ⸓
    </footer>
  </body>
</html>
