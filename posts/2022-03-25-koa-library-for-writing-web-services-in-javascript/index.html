<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Personal website for Boris Terzic with blog posts on programming and technology.">
    
    <title>Koa Implements a Nice Pattern For Writing Web Services</title>    
    <style>
/* Local Google fonts with the help of https://google-webfonts-helper.herokuapp.com  */

/* eb-garamond-regular - latin */
@font-face {
  font-family: 'EB Garamond';
  font-style: normal;
  font-weight: 400;
  src: local(''),
       url('/fonts/eb-garamond-v25-latin-regular.woff2') format('woff2');
  font-display: swap;
}

/* roboto-slab-regular - latin */
@font-face {
  font-family: 'Roboto Slab';
  font-style: normal;
  font-weight: 400;
  src: local(''),
       url('/fonts/roboto-slab-v23-latin-regular.woff2') format('woff2');
  font-display: swap;
}

/* From monica.css */
* {box-sizing: border-box}
[hidden] {display: none !important}
[disabled] {pointer-events:none; opacity: 0.3}
.horizontal {display: flex; flex-direction: row; justify-content: space-between}
.vertical {display: flex; flex-direction: column}
.center {justify-content: center; align-items: center}
.flex {flex: 1}
html {
  --spacing-xs: 8px;
  --spacing-s: 12px;
  --spacing: 24px;
  --spacing-m: 36px;
  /* Color scheme 324, page 233 from A Dictionary of Color Combinations */
  --pompeian-red: rgb(162, 46, 55);
  --olympic-blue: #247291;
  --aconite-violet: #85608e;
  --neutral-gray: #B5D1CC;
  --color-gainsboro: #DCDCDC;
  
  --color-code-bg: #f5f2f0;
}

/* TODO: dark theme */
@media (prefers-color-scheme: dark) {
}

/* Custom styles */
body {
  margin: 0;
  padding: 0;
  font-size: 16px;
  /* From https://www.smashingmagazine.com/2020/07/css-techniques-legibility/#top */
  line-height: calc(1ex / 0.32);
  font-family: 'Roboto Slab', serif;
}
::selection {
  background: var(--olympic-blue);
  color: white;
}
pre, code {
  font-family: monospace;
  font-size: 14px;
  border-radius: 3px;
}
header, footer {
  margin: auto;
  display: flex;
  justify-content: center;
}
main {
  max-width: 75ch;
  margin: auto;
  padding: 0 var(--spacing) var(--spacing) var(--spacing);
}
footer {
  font-size: 21px;
  margin-bottom: var(--spacing);
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'EB Garamond', serif;
}

nav {
  margin: auto;
  padding: var(--spacing-xs);
  font-family: sans-serif;
  text-transform: uppercase;
  
  font-weight: 500;
  margin: var(--spacing);
  /* Made with https://www.joshwcomeau.com/gradient-generator/ */
  background-image: linear-gradient(
    45deg,
    hsl(355deg 56% 41%) 0%,
    hsl(351deg 44% 41%) 13%,
    hsl(346deg 34% 41%) 25%,
    hsl(336deg 25% 41%) 37%,
    hsl(315deg 15% 40%) 50%,
    hsl(261deg 12% 42%) 63%,
    hsl(219deg 19% 42%) 75%,
    hsl(205deg 35% 40%) 87%,
    hsl(197deg 60% 35%) 100%
  );
  
  color: white;
  border-radius: 3px;
}
nav ol {
  margin: 0;
  bottom: 0;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}
nav ol li {
  margin: 0 var(--spacing-s);
}

nav ol li, main ol li {
  list-style-type: none;
}

nav a, nav a:visited {
  color: white;
  text-decoration: none;
}

nav a:hover {
  border-bottom: 1px dotted white;
  padding-bottom: 2px;
}

a, a:visited, a:active {
  text-decoration-skip-ink: auto;
}

a {
  color: var(--olympic-blue);
}

a:visited {
  color: var(--aconite-violet);
}

ol {
  padding-left: 0;
}

h1, h2, h3 {
  
  
  font-size: 170%;
}

h1, h2, h3, p {
  margin: var(--spacing-s) 0;
  font-weight: normal;
}

/* To make <time> be close to the header, this may be a bit too rough */
h1 {
  margin: 0;
}

h1 {
  border-bottom: 1px solid black;
  padding-bottom: var(--spacing-xs);
}

h2 {
  font-weight: normal;
}

main ol, main ul {
  margin: 0;
  padding: 0;
}

.cover {
  text-align: center;
  line-height: 400%;
  border-bottom: 1px solid black;
  border-top: 1px solid black;
  margin-bottom: var(--spacing);
}

.cover h1 {
  border: none;
  word-wrap: break-all;
}

.cover h1, .cover h2 {
  letter-spacing: 12px;
}

ol.postlist li {
  margin-bottom: var(--spacing-s);
}

span.postdate {
  display: block;
  text-align: left;
  margin: 0;
  font-family: monospace;
}

article time {
  font-style: italic;
  font-size: 12px;
}

pre {
  padding: var(--spacing-s);
  background-color: var(--color-code-bg);
  overflow-x: auto;
  overflow-y: hidden;
}
p code {
  background-color: var(--color-code-bg);
  padding: 0 4px;
}

.postlist time {
  display: block;
  font-family: monospace;
  font-size: 12px;
  line-height: 1;
}

@media only screen and (min-width: 1000px)  {
  .postlist time {
    display: inline-block;
    text-align: right;
    width: 19ch;
    margin: 0 0 0 -19ch;
    padding-right: 1ch;
  }

  .postlist a {
    
  }

  .postlist time:after {
    content: ' ·';
  }
}

    </style>
  </head>
  <body>
    <header>
      <nav>
        <ol>
          <li><a href="/">Home</a></li>
          <li><a href="/pages/blog-styleguide/">Styleguide</a></li>
          <li><a href="/pages/impressum/">About</a></li>
        </ol>
      </nav>
    </header>
    <main>
      <article>
<h1>Koa Implements a Nice Pattern For Writing Web Services</h1>

<time datetime="2022-03-20">2022-03-20</time>

<p>For <a href="https://github.com/aggregat4/dendriform">Dendriform</a> I needed a small library or framework to implement a JavaScript (or TypeScript) test server that I could use for running integration tests against. I needed basic HTTP protocol support, the ability to serve static content, define custom routes based on URL, HTTP method and Accept-Header.</p>
<p>The goto for backend JavaScript has long been <a href="https://expressjs.com/">Express</a> and it is presumably still a good choice. I noticed some complaints of Express not having out of the box async support. Looking around further it was surprisingly hard to identify a viable and popular candidate that was lightweight enough for my purposes.</p>
<p>After looking at a handful of possibilities I decided to give <a href="https://koajs.com/">Koa</a> a shot. It is apparently made (or started) by the creator(s) of Express and claims to be a more modern alternative with some of the learnings of working on Express baked in.</p>
<p>Koa builds on the standard node.js HTTP server and offers a small middleware based API. The project is structured as one core library and then many different projects that contribute additional functionality that can be composed using its middleware API.</p>
<p>The imports for my tiny test server look like this:</p>
<pre><code class="language-javascript">import Koa from 'koa'
import Router from '@koa/router'
import bodyParser from 'koa-body'
import logger from 'koa-logger'
import mount from 'koa-mount'
import serve from 'koa-static'
</code></pre>
<p>This is the core Koa import and then additional modules for the functionality I need:</p>
<ul>
<li><a href="https://github.com/koajs/router">Koa Router</a>: adds an API for routing requests to functions based on HTTP method, URL, etc.</li>
<li><a href="https://github.com/koajs/koa-body">Koa Body</a>: extends the Koa API with various useful utilities for parsing request bodies in various formats.</li>
<li><a href="https://github.com/koajs/logger">Koa Logger</a>: allows you to easily log all requests, responses and status codes to make debugging easier.</li>
<li><a href="https://github.com/koajs/mount">Koa Mount</a>: allows mounting <em>other</em> middleware on a certain path inside your application.</li>
<li><a href="https://github.com/koajs/static">Koa Static</a>: allows serving static files directly from disk.</li>
</ul>
<p>Koa Mount is a nice example of the composability of the middleware pattern: I use it to expose the static files provided by Koa Static on a certain URL inside of my own application. Neither of these components need to know about each other.</p>
<p>All in all it was a very pleasant experience to implement a simple web service with Koa and I can recommend it for this use case. You can have a look at the full service implementation here: <a href="https://github.com/aggregat4/dendriform/blob/a378143c18a23d215a5734f1952b8f6aa8bb66e3/test/e2e/tiny-dendriform-server.ts">tiny-dendriform-server.ts</a>.</p>
<p>It feels like the middleware pattern is quasi-optimal for the use case of exposing web services and having the ability to add a bunch of cross-cutting concerns (logging, authentication, authorization, etc) on top of your actual service logic.</p>
<p>I discovered some non critical downsides to Koa during my very limited usage of the library.</p>
<p>It's unclear to me how alive this project is: there are occasional releases being made, but the main development effort was some years ago and there is disturbingly little traffic on the issues or code bases of some of the components. This may also just be a case of me no knowing where the actual community takes place, or perhaps the library is just really mature and works for most people.</p>
<p>Documentation exists but seems thin and somewhat spotty. I had to resort to reading a bunch of the example code and tests in their repository. And it was sometimes hard to figure out the exact recommended way to solve a particular problem. On the up side: there <em>are</em> tests and example code.</p>
<p>Recommended.</p>


</article>

    </main>
    <footer>
      <!-- dotted diple -->
      ⸓
    </footer>
  </body>
</html>
